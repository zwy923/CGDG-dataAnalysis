# 电力收益分析系统

这是一个用于分析电力现货交易数据的综合系统，包含日前结算收益分析和原合约优化分析两大功能模块。

## 功能概述

### 1. 日前结算收益分析器
- 分析Excel文件中的日前结算收益负值
- 支持按日、月、年查询
- 提供详细的数据汇总和统计

### 2. 原合约优化分析器（新增功能）
- 分析"统计图"表中的数据
- 优化原合约使总收入最大
- 生成每日96个时间点的最优原合约曲线
- 计算月度平均原合约曲线
- 提供可视化图表分析

### 3. 原合约比例调整分析功能（升级）
- **保持优化分布不变**：维持各时间点之间的相对比例关系
- **灵活比例调整**：支持0.25倍、0.5倍（减半）、1.5倍、2.0倍（双倍）或自定义倍数
- **重新计算收入**：基于调整后的原合约值重新计算总收入
- **详细对比分析**：提供调整前后的全面对比
- **可视化展示**：生成调整前后的对比图表
- **向后兼容**：仍支持原有的减半分析功能

### 4. 原始合约量比例调整分析功能（全新）
- **使用原始数据**：直接读取Excel表中的原始合约量，无需优化处理
- **多比例同时分析**：同时计算0.25倍、0.5倍、1.5倍等多种比例的收益
- **自定义比例支持**：用户可输入任意比例组合进行分析
- **最佳比例识别**：自动识别收益最高的调整比例
- **详细收益对比**：提供各比例下的收益变化和百分比对比
- **月度批量分析**：支持整月数据的批量比例调整分析

## 系统要求

- Python 3.7+
- Windows 10/11

## 安装依赖

运行以下命令安装所需的Python包：

```bash
pip install -r requirements.txt
```

或者双击运行 `启动.bat` 文件，选择选项3进行安装。

## 使用方法

### 方法1：使用启动脚本（推荐）

双击运行 `启动.bat` 文件，然后选择要运行的程序：

1. **日前结算收益分析器** - 分析日前结算收益数据
2. **原合约优化分析器** - 分析原合约优化
3. **安装依赖包** - 安装所需的Python包

### 方法2：直接运行Python脚本

```bash
# 运行日前结算收益分析器
python interactive_analyzer.py

# 运行原合约优化分析器
python contract_optimizer.py
```

## 原合约优化分析功能详解

### 核心概念

根据您的要求，系统实现了以下优化逻辑：

1. **原合约取值范围**：(0, 12)
2. **总收入计算公式**：总收入 = 原合约 × 合约电价 - 原合约 × 日前电价
3. **约束条件**：
   - 每日原合约总量不超过用户设定的限制值（如5月每天451.527）
   - 每个时间点的原合约值在(0, 12)范围内
4. **优化策略**：
   - 使用线性规划算法在约束条件下最大化总收益
   - 优先分配给收益最高的时间点
   - 当线性规划失败时，使用贪心算法作为备选方案

## 原始合约量比例调整分析功能详解（新功能）

### 功能概述

这是一个全新的分析功能，**直接使用Excel表中的原始合约量数据**，而不依赖于优化算法。该功能允许用户快速比较不同比例调整下的收益表现，自动识别最佳调整策略。

### 核心特点

1. **原始数据驱动**
   - 直接读取Excel"统计图"表中的原始合约量列
   - 无需进行优化计算，保持数据的原始性
   - 支持自动识别包含"原合约"、"合约量"等关键词的列

2. **多比例同步分析**
   - **默认比例**：0.25倍（四分之一）、0.5倍（减半）、1.5倍
   - **自定义比例**：支持用户输入任意比例组合，如 0.3,0.8,1.2,2.0
   - **并行计算**：同时计算所有比例下的收益，提高分析效率

3. **智能结果分析**
   - 自动识别收益最高的调整比例
   - 提供各比例的收益变化和百分比对比
   - 显示相对于原始合约的增益或损失

4. **月度批量处理**
   - 支持整月数据的批量分析
   - 提供月度汇总统计和最佳/最差比例识别
   - 失败日期自动记录和报告

### 使用场景

- **快速策略评估**：无需复杂优化，快速评估不同合约量水平的收益影响
- **风险控制分析**：通过减少合约量（如0.25倍、0.5倍）评估风险控制效果
- **扩张策略分析**：通过增加合约量（如1.5倍、2.0倍）评估扩张收益潜力
- **最优策略发现**：在多个比例中自动找出收益最大化的策略

### 操作流程

#### 单日分析（选项5）

1. **输入日期**：例如 `2025-05-10`
2. **选择比例模式**：
   - 默认模式：使用 0.25、0.5、1.5 倍
   - 自定义模式：输入如 `0.25,0.5,1.0,1.5,2.0`
3. **查看分析结果**：
   - 原始合约量统计
   - 各比例下的收益对比
   - 最佳调整比例推荐

#### 月度分析（选项6）

1. **输入月份**：例如 `2025-05`
2. **选择比例模式**：同单日分析
3. **查看月度报告**：
   - 月度基础信息（处理天数、总合约量、总收益）
   - 比例调整收益对比表
   - 最佳和最差调整比例
   - 日平均收益对比

## 原合约比例调整分析功能详解（优化算法）

### 功能特点

1. **分布保持不变**
   - 各时间点之间的相对比例完全保持不变
   - 相关系数为1.0，确保分布形状完全一致

2. **灵活比例调整**
   - **预设选项**：0.25倍（四分之一）、0.5倍（减半）、1.5倍、2.0倍（双倍）
   - **自定义倍数**：支持任意正数倍数（如0.3、1.2、2.5等）
   - **精确处理**：每个时间点的原合约值都按精确比例调整
   - **总量同步**：月总合约量按相同比例调整

3. **全面收入重算**
   - 基于调整后的原合约值重新计算每日收入
   - 计算月度总收入和平均收入
   - 提供调整前后的收入对比

4. **详细统计分析**
   - 基本统计对比（合约值、合约量变化）
   - 收入对比（月总收入、日平均收入）
   - 约束验证（总量限制是否满足）
   - 分布保持验证（相关系数检验）

5. **可视化对比**
   - 原合约值对比曲线
   - 调整比例验证图（动态y轴范围）
   - 每日收入对比柱状图
   - 统计汇总信息

### 使用流程

1. **运行月度优化分析**
   ```bash
   python contract_optimizer.py
   # 选择选项 2: 分析月度原合约优化
   # 输入月份，如: 2025-05
   # 输入每日总量限制
   ```

2. **查看原始优化结果**
   - 系统显示月度优化分析结果
   - 可选择是否显示详细收益分解
   - 可选择是否绘制月度分析图表

3. **进行比例调整分析**
   - 系统询问：是否进行原合约比例调整分析?
   - 选择 `y` 后，系统提供以下选项：
     - 1. 0.25倍（四分之一）
     - 2. 0.5倍（减半）
     - 3. 1.5倍（增加50%）
     - 4. 2.0倍（双倍）
     - 5. 自定义倍数
   - 选择合适的调整比例

4. **查看调整结果**
   - 显示详细的调整前后对比分析
   - 包含统计数据、收入变化、约束验证等
   - 可选择绘制调整前后对比图表

### 输出信息解读

#### 基本统计对比
- **月平均合约值**：所有时间点合约值的平均值
- **月总合约量**：所有时间点合约值的总和
- **变化百分比**：调整后相对于调整前的变化比例

#### 收入对比
- **月总收入**：整个月的总收入
- **日平均收入**：平均每天的收入
- **收入变化**：调整后收入的绝对变化和百分比变化

#### 约束验证
- **等式约束满足情况**：验证是否满足每日总量限制
- **建议新限制**：调整后建议的新总量限制值（原限制 × 调整倍数）

#### 分布保持验证
- **相关系数**：验证调整前后分布的一致性（应为1.0）
- **调整比例统计**：验证各时间点是否都按指定倍数精确调整

### 注意事项

1. **数据完整性**：确保指定月份的Excel数据文件完整
2. **约束调整**：调整后需要相应调整每日总量限制为原值的对应倍数
3. **分布不变**：比例调整操作保证各时间点的相对关系完全不变
4. **收入变化**：调整后的收入变化取决于合约电价、日前电价的关系以及调整倍数
5. **倍数选择**：倍数必须为正数，建议根据实际业务需求选择合适的调整比例

### 数据要求

Excel文件需要包含以下工作表：
- **统计图** - 包含分析所需的所有数据

统计图表中需要包含以下列（列名包含关键词即可）：

**基础必需列：**
- 合约电价
- 日前电价

**原始合约量调整功能需要：**
- 原合约量 / 原合约 / 合约量（用于新的原始合约量分析功能）

**可选列（用于收益计算）：**
- 撮合电价
- 实时电价
- 省间现货电价
- 撮合收益
- 日前结算收益
- 实时结算收益
- 省间现货收益

## 文件结构

```
日结结算收益/
├── interactive_analyzer.py    # 日前结算收益分析器
├── contract_optimizer.py      # 原合约优化分析器
├── power_analyzer.py          # 核心分析模块
├── requirements.txt           # 依赖包列表
├── 启动.bat                   # 启动脚本
├── README.md                  # 说明文档
└── *.xlsx                     # Excel数据文件
```

## 使用示例

### 示例1：分析单日原合约优化

1. 运行 `启动.bat`
2. 选择选项2（原合约优化分析器）
3. 选择选项1（分析单日原合约优化）
4. 输入日期：`2025-05-10`
5. 输入每日总量限制：`451.527`
6. 系统自动进行约束优化分析
7. 查看分析结果和图表

### 示例2：分析月度原合约优化

1. 运行 `启动.bat`
2. 选择选项2（原合约优化分析器）
3. 选择选项2（分析月度原合约优化）
4. 输入月份：`2025-05`
5. 输入每日总量限制：`451.527`
6. 系统分析该月所有日期的优化结果
7. 查看月度分析结果和统计图表

### 示例3：分析单日原始合约量调整（新功能）

1. 运行 `启动.bat`
2. 选择选项2（原合约优化分析器）
3. 选择选项5（分析单日原始合约量调整）
4. 输入日期：`2025-05-10`
5. 选择比例模式：
   - 选择 `n` 使用默认比例（0.25, 0.5, 1.5）
   - 或选择 `y` 输入自定义比例：`0.25,0.5,1.0,1.5,2.0`
6. 系统自动分析各比例下的收益
7. 查看最佳调整比例推荐

### 示例4：分析月度原始合约量调整（新功能）

1. 运行 `启动.bat`
2. 选择选项2（原合约优化分析器）
3. 选择选项6（分析月度原始合约量调整）
4. 输入月份：`2025-05`
5. 选择比例模式：默认或自定义
6. 系统批量分析该月所有日期的数据
7. 查看月度收益对比报告和最佳策略推荐

## 注意事项

1. **数据格式**：确保Excel文件包含"统计图"工作表
2. **列名匹配**：系统会自动查找包含关键词的列名
3. **数据质量**：确保电价数据为数值格式
4. **文件命名**：Excel文件名应包含日期信息（如：2025年大市风电场现货交易日报(5月10日).xlsx）

## 技术支持

如果遇到问题，请检查：
1. Python环境是否正确安装
2. 依赖包是否完整安装
3. Excel文件格式是否正确
4. 数据列名是否包含必要关键词